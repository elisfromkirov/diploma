\section{Система управления персонажем}

Работа системы управления персонажем состоит из двух стадий: оптимизации и прямой динамики, повторяемых в цикле. Во время оптимизации вычисляются силы и моментов сил, которые должны должны сгенерировать приводы, и силы реакции опоры, такие, чтобы получаемое движение было сбалансированным и следовало опорной анимации. Результаты оптимизации передаются в алгоритм прямой динамики, который находит ускорения. Далее эти ускорения применяются к персонажу. Таким образом он приводится в движение.

Внешние возмущения, если пресутсвуют, также передаются в алгоритм прямой динамики. Ошибки, которые они вносят в движение, компенсируются оптимизатором на следующих циклах.

На рисунке \ref{fig:architecture} схематично изображена работа системы.

\begin{figure}[ht]
  \begin{minipage}{\textwidth}
    \centering
    \begin{tikzpicture}
        \node [rectangle, minimum width = 4cm, minimum height = 2cm, draw] at (-3, 0) {Оптимизация};
        \node [rectangle, minimum width = 4cm, minimum height = 2cm, draw] at (3, 0) {Прямая динамика};
        \draw [-{Latex[length=3mm, width=2mm]}] (-1,0)  -- node[above = 1mm] {$u, f$} (1,0);
        \draw [-{Latex[length=3mm, width=2mm]}] (3, 2.5) -- node[right = 1mm] {$f_{d}$} (3, 1);
        \draw [-] (3, -1) -- (3, -2.5);
        \draw [-] (3, -2.5) -- node[below = 1mm] {$q, \dot{q}, \ddot{q}$} (-3, -2.5);
        \draw [-{Latex[length=3mm, width=2mm]}] (-3, -2.5) -- (-3, -1);
      \end{tikzpicture}
    \caption{Работа системы управления}
    \label{fig:architecture}
  \end{minipage}
\end{figure}

\subsection{Оптимизация}

Оптимизация -- это ключевая стадия работы системы управления, ответственная за вычисление сил и моментов сил, которые должны генерировать приводы. Оптимизация выбрана поскольку она позволяет учесть все условия, влияющих на значения сил и моментов сил, в виде целевой функции или ограничений.

Задача оптимизации имеет следующий вид
\begin{align*}
  \min_{\ddot{q}, u, f} &\ \omega_{t} h_{t}(\ddot{q}) + \omega_{c} h_{c}(\ddot{q}) + \omega_{p} h_{p}(\ddot{q}) + \omega u^{T} \begin{bmatrix} I_{6} & O \\ O & O \end{bmatrix} u \\
  s.t. &\ H \ddot{q} + C(q, \dot{q}) + G(q) = u + J^{T} f \tag{2.1}\label{eq:2.1} \\
       &\ J_{sup} \ddot{q} + \dot{J}_{sup} \dot{q} = 0 \tag{2.2}\label{eq:2.2} \\
       &\ 0 \le n(f) \tag{2.3}\label{ineq:2.3} \\
       &\ \tau(f) \le \mu n(f) \tag{2.4}\label{ineq:2.4}
\end{align*}

Целевая функция оптимизации состоит из четырех слагаемых. Первые три из них -- $h_{t}$, $h_{c}$ и $h_{p}$ -- отвечают за следование опорной анимации, за положения центра масс и за положения центра давления соответственно. Последнее стремиться минимизировать силы и моменты сил, генерируемые в корневом шарнире. Веса $w_{t}$, $w_{c}$, $w_{p}$ и $w$ -- позволяют регулировать значимость вклада каждого из слагаемых.

Отметим, что последнее слагаемое важно для надежности и простоты настройки системы, поскольку оно обеспечивает обработку ситуаций, когда значения функций $h_{t}$, $h_{c}$ и $h_{p}$ значительно отклоняются от оптимальных и не могут быть восстановлены без генерации сил и моментов сил в корневом шарнире. Обычно вместо последнего слагаемого используется ограничение, требующее равенства сил и моментов сил в корневом шарнире нулю. Однако тогда система не может обработать ситуации выше. Применительно к анимациям в видео играх выбор в пользу надежности за счет возможной потери физической корректности может оказаться целесообразным.

Уравнение \ref{eq:2.1} согласует результаты оптимизации с уравнением динамики кинематического дерева. Таким образом, обобщенные ускорения, полученные применением алгоритма прямой динамики, в случае отсутствия внешних возмущений будут совпадать с теми, что найдены во время оптимизации. Уравнение \ref{eq:2.2} оставляет точки контакта с поверхностью неподвижными. Неравенства \ref{ineq:2.3} и \ref{ineq:2.4} отвечают за направление силы реакции опоры.

Функции $h_{t}$, $h_{c}$ и $h_{p}$ формулируются так, чтобы получившаяся задача оптимизации была квадратичной. Квадратичное программирование успешно применялось в других системах \cite{AbeSP}, \cite{MacchiettoZS}, \cite{SilvaAP}, поскольку оно дает дает предсказуемое время работы оптимизатора и воспроизводимые результаты.

Следующие подразделы посвящены функциям $h_{t}$, $h_{c}$ и $h_{p}$. Поскольку кинематическая характеристика, которую можно контролировать, -- это обобщенные ускорения, функции формулируются следующим образом: описывается желаемое ускорение, после чего определяется функция, оптимизация которой минимизирует отклонение получаемого ускорения от желаемому.

\subsubsection{Следование опорной анимацией}

Функция $h_{t}(\ddot{q})$ ответственна за поддержание стилистической составляющей движения, задаваемой с помощью опорной анимации. Основная задача этой функции в том, чтобы получаемое движение как можно точнее приближало опорную анимацию. Наивный способ добиться этого -- это взять $h_{t}(\ddot{q})$ такой, чтобы в результате оптимизации полученное ускорение совпадало ускорением из опорной анимации. Однако, в таком случае, если получаемое движение отклоняется от опорной анимации, например, в следствие внешних возмущений, то оно не будет скорректировано обратно. Поэтому функция $h_{t}(\ddot{q})$ включает слагаемые, которые характеризую отставание, и определяется следующим образом
\begin{equation*}
  h_{t}(\ddot{q}) = \lVert W (\ddot{q} + s_{t} (q - q_{ref}) + d_{t} (\dot{q} - \dot{q}_{ref}) - \ddot{q}_{ref}) \rVert_{2}^{2},
\end{equation*}
где $W$ -- диагональная матрица весов, $s_{t}$ и $d_{t}$ -- коэффициенты, а $q_{ref}$, $\dot{q}_{ref}$ и $\ddot{q}_{ref}$ -- это положение, скорость и ускорение взятые из опорной анимации. Матрица $W$ позволяет более точно настроить систему, сохранить требуемые особенностей опорной анимации. В данной работе матрица $W$ единичная.

Выражение $s_{t} (q - q_{ref}) + d_{t} (\dot{q} - \dot{q}_{ref})$ использованное в определении $h_{t}$ называется \break пропорционально-дифференцирующий регулятор, а коэффициенты $s_{t}$ и $d_{t}$ -- пропорциональный и дифференциальный соответственно.

Отметим, что пропорционально-дифференцирующий регулятор также помогает смягчить ошибки связанные с работой с числами с плавающей точкой.

\subsubsection{Контроль положением центра масс}

Положение центра масс является хорошо известным индикатором баланса персонажа \cite{AbeSP}, \cite{MacchiettoZS}. В случае если проекция положения центра масс на поверхность находится вне опорного полигона, то есть выпуклой оболочки, образованной точками контакта с поверхностью, то персонаж может упасть. Таким образом, стратегия контроля положения центра масс состоит в том, чтобы поддерживать его проекцию на поверхность внутри опорного полигона, причем как можно дальше от границы.

Реализовать это можно по разному. Простая и при этом эффективная реализация -- это выбор функции $h_c(\ddot{q})$ такой, чтобы в результате оптимизации проекция положение центра масс двигалось в направлении центра опорного полигона. Более точно, такой, чтобы ускорение центра масс стремилось к следующему значению
\begin{equation*}
  \ddot{c}_{des} = - s_{c} (c - c_{ref}) - d_{c} (\dot{c} - \dot{c}_{ref}), \tag{2.6}\label{eq:2.6}
\end{equation*}
где $s_{c}$ и $d_{c}$ -- коэффициенты, а $c_{ref}$ и $\dot{c}_{ref}$ -- опорные положение и скорость центра масс. Такая формулировка желаемого ускорения центра масс делает контроль его положения более настраиваемым. В данной работе $c_{ref}$ выбрано как положение центра опорного полигона, а $\dot{c}_{ref}$ равно нулю. С другой стороны, $c_{ref}$ и $\dot{c}_{ref}$ могут быть взяты из опорной анимации. Отметим, что коэффициенты $s_{c}$ и $d_{c}$ могут быть константами или значениями, меняющимися в зависимости от состояния персонажа, как это сделано в \cite{AbeSP}.

% TODO: Control over gravitational axis is not important. Equation is only taken along the two axes.

Преобразуем уравнение \ref{eq:2.6} к виду необходимому, чтобы сформулировать $h_c(\dot{q})$. Умножением обоих частей на массу, уравнение \ref{eq:2.6} принимает вид
\begin{equation*}
  m \ddot{c}_{des} = - s_{c} m (c - c_{ref}) - d_{c} m \dot{c}. \tag{2.7}\label{eq:2.7}
\end{equation*}
Подставляя $m \ddot{c}_{des}$ и $m \dot{c}$ из уравнений \ref{eq:1.10} и \ref{eq:1.11}, уравнение \ref{eq:2.7} принимает вид
\begin{equation*}
  \dot{P}_{des} = - s_{c} m (c - c_{ref}) - d_{c} P. \tag{2.8}\label{eq:2.8}
\end{equation*}
Подставляя $P$ из уравнения \ref{eq:1.3}, уравнение \ref{eq:2.8} принимает вид
\begin{equation*}
  \dot{P}_{des} = - s_{c} m (c - c_{ref}) - d_{c} A_{P} \dot{q}. \tag{2.9}\label{eq:2.9}
\end{equation*}

Функцию $h_c(\ddot{q})$ можно сформулировать как квадратичное отклонения получаемого импульса от желаемого импульса. Поскольку оптимизация происходит по переменным $\ddot{q}$, $u$, $f$ получаемый импульс необходимо выразить через обобщенные ускорения, используя уравнение \ref{eq:1.5}. Таким образом $h_c(\ddot{q})$ имеет вид
\begin{equation*}
  h_{c}(\ddot{q}) = \lVert A_{P}\ddot{q} - \dot{A_{P}} \dot{q} - P_{des} \rVert_{2}^{2} \tag{2.10}\label{eq:2.10}
\end{equation*}

\subsubsection{Контроль положения центра давления}

Положение центра давления является индикатором вращательной устойчивости движения персонажа \cite{MacchiettoZS}, \cite{GoswamiK}. В случае если положение центра давления находится вне опорного полигона, то персонаж может опрокинуться. Кроме того, в случае если центр давления находится на границе опорного полигона, может возникнуть вращение опоры, то есть стоп персонажа. Таким образом, стратегия контроля положения центра давления состоит в том чтобы поддерживать его строго внутри опорного полигона.

Реализовать эту можно аналогично тому как сделан контроль положения цента масс. А именно, выбрать функцию $h_{p}(\ddot{q})$ такой, чтобы ускорения центра давления стремилось к следующему значению
\begin{equation*}
  \ddot{p}_{des} = - s_{p} (p - p_{ref}) - d_{p} (\dot{p} - \dot{p}_{ref}), \tag{2.11}\label{eq:2.11}
\end{equation*}
где $s_{p}$ и $d_{p}$ -- коэффициенты, а $p_{ref}$ и $\dot{p}_{ref}$ -- опорные положение и скорость центра давления. В данной работе $d_{ref}$ выбрано как положение центра опорного полигона, а $\dot{d}_{ref}$ равно нулю.

Преобразуем уравнение \ref{eq:2.11} к виду необходимому, чтобы сформулировать $h_p(\dot{q})$. Интегрируя $\ddot{p}_{des}$ получим значение $p_{des}$. Используя уравнение \ref{eq:1.9} получим
\begin{equation*}
  \dot{L}_{des} = (p_{des} - c) \times (P_{des} - mg). \tag{2.12}\label{eq:2.12}
\end{equation*}
Отметим, что при использовании уравнения \ref{eq:1.9} значение импульса взято из уравнения \ref{eq:2.9}, для того чтобы контроль положения центра давления был согласован с контролем положения центра масс.

Функцию $h_{p}(\ddot{q})$ можно сформулировать как квадратичное отклонения получаемого импульса от желаемого импульса. Поскольку оптимизация происходит по переменным $\ddot{q}$, $u$, $f$ получаемый импульс необходимо выразить через обобщенные ускорения, используя уравнение \ref{eq:1.5}. Таким образом $h_c(\ddot{q})$ имеет вид
\begin{equation*}
  h_{p}(\ddot{q}) = \lVert A_{L}\ddot{q} - \dot{A_{L}} \dot{q} - L_{des} \rVert_{2}^{2} \tag{2.13}\label{eq:2.13}
\end{equation*}

\subsubsection{Положением точек контакта с поверхностью}

Для того чтобы контакт персонажа с поверхностью был нескользящим, точки контакта должны оставаться неподвижными.

Пусть имеется $k$ точек контакта с поверхностью пронумерованных от $1$ до $k$. Соответствующие Якобианы равны $J_{1}, \ldots, J_{k}$. Тогда скорости точек контакта с поверхностью, обозначаемые $v_{1}, \ldots, v_{k}$, имеют следующий вид
\begin{equation*}
  \begin{bmatrix} v_{1} \\ \vdots \\ v_{k} \end{bmatrix} = \begin{bmatrix} J_{1} \\ \vdots \\ J_{k} \end{bmatrix} \dot{q}. \tag{2.14}\label{eq:2.14}
\end{equation*}
Обозначим столбец скоростей через $v_{sup}$, а столбец Якобианов -- $J_{sup}$. Тогда уравнение \ref{eq:2.14} приобретает вид
\begin{equation*}
  v_{sup} = J_{sup} \dot{q}. \tag{2.15}\label{eq:2.15}
\end{equation*}
Дифференцируя уравнение \ref{eq:2.15}, получаем выражение для ускорений $a_{sup}$ следующего вида
\begin{equation*}
  a_{sup} = J_{sup} \ddot{q} + \dot{J}_{sup} \dot{q}. \tag{2.16}\label{eq:2.16}
\end{equation*}

Для того чтобы скорости точек контакта с поверхностью оставались равными нулю, необходимо поддерживать ускорение равным нулю. Таким образом условие неподвижности точек контакта с опорой имеет следующий вид
\begin{equation*}
  J_{sup} \ddot{q} + \dot{J}_{sup} \dot{q} = 0. \tag{2.17}\label{eq:2.17}
\end{equation*}

\subsubsection{Направление силы реации опры}

Пусть функция $n(f): \mathbb{R}^{3} \rightarrow \mathbb{R}$ возвращает величину проекции $f$ на нормаль к поверхности, функция $\tau(f): \mathbb{R}^{3} \rightarrow \mathbb{R}$ возвращает величину проекции $f$ на поверхность.

Поскольку сила нормальной реакции направлена вдоль нормали к поверхности и связана с силой трения посредством коэффициента трения, задача оптимизации должна содержать неравенства выражающие это
\begin{align*}
&\ 0 \le n(f) \tag{2.18}\label{ineq:2.18} \\
&\ \tau(f) \le \mu n(f) \tag{2.19}\label{ineq:2.19}
\end{align*}

\subsection{Прямая динамика}

Прямая динамика -- это стадия, во время которой происходит вычисление ускорений, которые будут применяться к персонажу. Кроме того наличие этой стадии позволяет системе восстанавливать баланс в присутствии внешних возмущений. Поскольку величина внешних возмущений еще не известна на стадии оптимизации, она полагается на результаты прямой динамики, и корректирует их в соответствии с требованиями к движению.

В данной работе используется алгоритм articulated rigid body, описанный в \cite{Featherstone}. Он выбран поскольку обладает наименьшей вычислительной сложность среди алгоритмов прямой динамики.
