\section{Система управления персонажем}

Работа системы управления персонажем состоит из двух стадий: оптимизации и прямой динамики, повторяемых в цикле. Во время оптимизации вычисляются силы и моментов сил, которые должны должны сгенерировать приводы, и силы реакции опоры. Результаты оптимизации передаются в алгоритм прямой динамики, который находит ускорения, для дальнейшего интегрирования.

Внешние возмущения, если пресутсвуют, также передаются в алгоритм прямой динамики. Ошибки, которые они вносят в движение, компенсируются оптимизатором на следующих циклах.

На рисунке \ref{fig:architecture} схематично изображена работа системы.

\begin{figure}[h]
  \begin{minipage}{\textwidth}
    \centering
    \begin{tikzpicture}
        \node [rectangle, minimum width = 4cm, minimum height = 2cm, draw] at (-3, 0) {Оптимизация};
        \node [rectangle, minimum width = 4cm, minimum height = 2cm, draw] at (3, 0) {Прямая динамика};
        \draw [-{Latex[length=3mm, width=2mm]}] (-1,0)  -- node[above = 1mm] {$u, f$} (1,0);
        \draw [-{Latex[length=3mm, width=2mm]}] (3, 2.5) -- node[right = 1mm] {$f_{d}$} (3, 1);
        \draw [-] (3, -1) -- (3, -2.5);
        \draw [-] (3, -2.5) -- node[below = 1mm] {$q, \dot{q}, \ddot{q}$} (-3, -2.5);
        \draw [-{Latex[length=3mm, width=2mm]}] (-3, -2.5) -- (-3, -1);
      \end{tikzpicture}
    \caption{Работа системы управления}
    \label{fig:architecture}
  \end{minipage}
\end{figure}

Отметим, что похожая схема работы описана в \cite{AbeSP}. Однако она имеет другую формулировку задачи оптимизации, что является важным отличием, делающим, систему, предложенную в данной работе, более надежной.

\subsection{Оптимизация}

Задача оптимизации имеет следующий вид
\begin{align*}
  \min_{\ddot{q}, u, f} &\ \omega_{t} h_{t}(\ddot{q}) + \omega_{c} h_{c}(\ddot{q}) + \omega_{p} h_{p}(\ddot{q}) + \omega u^{T} \begin{bmatrix} I_{6} & O \\ O & O \end{bmatrix} u \\
  s.t. &\ H \ddot{q} + C(q, \dot{q}) + G(q) = u + J^{T} f \tag{2.1}\label{eq:2.1} \\
       &\ J_{sup} \ddot{q} + \dot{J_{sup}} \dot{q} = 0 \tag{2.2}\label{eq:2.2} \\
       &\ 0 \le n(f) \tag{2.3}\label{ineq:2.3} \\
       &\ \tau(f) \le \mu n(f) \tag{2.4}\label{ineq:2.4}
\end{align*}

Целевая функция оптимизации состоит из четырех слагаемых. Первые три из них -- $h_{t}$, $h_{c}$ и $h_{p}$ -- отвечают за следование опорной анимации, за положения центра масс и за положения центра давления соответственно. Последнее стремиться минимизировать силы и моменты сил, генерируемые в корневом шарнире. Веса $w_{t}$, $w_{c}$, $w_{p}$ и $w$ -- позволяют регулировать значимость вклада каждого из слагаемых.

Уравнение \ref{eq:2.1} согласует результаты оптимизации с уравнением динамики кинематического дерева. Уравнение \ref{eq:2.2} оставляет точки контакта с поверхностью неподвижными. Неравенства \ref{ineq:2.3} и \ref{ineq:2.4} отвечают за направление силы реакции опоры.

% Определение целевых функций оптимизации будет происходить следующим образом

\subsubsection{Следование за опорной анимацией}

% Тут тоже очев
% Тут же скажем про PD controller
% И про соотношение между proportional gain и derivative gain

\subsubsection{Контроль положения центра масс}

% Для того чтобы персонаж не переворачивался, 

% Первое из условий баланса -- это нахождение проекции центра масс персонажа на поверхность внутри выпуклой оболочки, образованной точками контакта с поверхностью. В противном случае персонаж переверн

% Для поддержания оптимизатор будет стремиться приводить c к выобраному опорному положению c_ref использую  

\begin{equation*}
  \ddot{c}_{des} = - s_{c} (c - c_{ref}) - d_{c} \dot{c}
\end{equation*}

% домножим обе части уравнения на массу

\begin{equation*}
  m \ddot{c}_{des} = - m s_{c} (c - c_{ref}) - m d_{c} \dot{c}
\end{equation*}

% используя уравнения 8 преобразуем к виду

\begin{equation*}
  \dot{P}_{des} = - m s_{c} (c - c_{ref}) - d_{c} P
\end{equation*}

% используя уравнение (?) преобразуем к виду

\begin{equation*}
  \dot{A}_{P} \dot{q} + A_{P} \ddot{q}_{des} = - m s_{c} (c - c_{ref}) - d_{c} A_{P} \dot{q}
\end{equation*}

% переставляя слагаемые

\begin{equation*}
  A_{P} \ddot{q}_{des} = - m s_{c} (c - c_{ref}) - d_{c} A_{P} \dot{q} - \dot{A}_{P} \dot{q}
\end{equation*}

% Таким образом функция h_c

\begin{equation*}
  h_{c}(\ddot{q}) = \lVert A_{P} (\ddot{q} - \ddot{q}_{des} ) \rVert = \lVert A_{P} \ddot{q} + m s_{c} (c - c_{ref}) + d_{c} A_{P} \dot{q} + \dot{A}_{P} \dot{q} \rVert
\end{equation*}

% Правило для c_{ref} -- это опорная

% Одно из условий сбалансированности

% нахождение проекции центра масс 

% В противном случае персонаж попросту перевернется

% Правило для него выглядит следующим образом

\subsubsection{Контроль положения центра давления}

% Вот тут начнется прикол

\subsubsection{Контроль точек контакта с поверхностью}

% поскольку мы занимаемся статическим балансам необходимо следить за тем чтобы опорные точки не отрывались от поверхности на которой стоит ля

\subsubsection{Контроль направления силы реации опры}

% результирующая сил трения и сил нормальной реакции опоры не может иметь произвольное направление, поскольку сила трения и N  через коэффициент трения

% Уравнение прямой динамики

% \subsection{Реализация системы}
% Для реализации системы использовались pinocchio и cvxopt


% Оптимизация имеет четыре ограничения. Первое из них согласует результаты с уравнением динамики кинематического дерева. Второе оставляет точки контакта с поверхностью неподвижными. Последние два отвечают за направление 

% Ограничения оптимизации наложены для получения физически корректных результатов. Первое из них согласует результаты оптимизации с уравнением динамики кинематического дерева.

% Первое .
% Второе отвечает за направление силы нормальной реакции опоры.
% 

% Ограничения оптимизации

% Первое из них -- это уравнение динамики. Второе 

% Функции  -- отвечают за следование опорной анимации, за контроль положения центра масс и за контроль положения центра давления. Веса $w_{t}$, $w_{c}$ и $w_{p}$ позволяют настраивать вклад каждой из них. Последнее слагаемое целевой функции оптимизации минимизирует силы и моменты сил, генерируемые в корневом шарнире.

% Ограничения оптимизации 

% делая контролеер более

% Второе из ограничений

% Целевые функции отвечают за достижение целей контроллера.

% Ограничение оптимизации отвечают за сохранение физической

% Первое ограничение требует выполнения уравнения

% уравнением движения, коэффи

