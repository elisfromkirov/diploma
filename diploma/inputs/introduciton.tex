\section{Введение}

Одна из основных задач, стоящих перед разработчиками и исследователями в области анимации, -- это воспроизведение разнообразия движений человека, с целью  создания персонажей, способных реалистично взаимодействовать с игровым миром. Несмотря на сложности, связанные с недостаточным пониманием всех тонкостей движения человека, множество подходов к решению этой задачи было предложено за последние десятилетия. Существующие подходы можно разделить на две группы: основанные на данных и основанные на физическом моделировании. Первая группа использует большое количество предварительно записанных движений человека, для создания необходимых анимаций персонажа. Такие подходы демонстрируют хорошие результаты, поскольку полагаются на данные собранные в реальном мире, однако плохо применимы в случае когда требуемое движение не стандартно и не похоже на имеющиеся. Вторая группа управляет динамикой физической модели персонажа. В таком случае обеспечивается физическая корректность и появляется возможность взаимодействия с виртуальной средой.

Широко распространенная проблема управления -- это поддержание баланса при движении, то есть предотвращение неконтролируемого падения персонажа. Особенно ярко проблема проявляется, когда персонаж находится в присутствии внешних возмущений или на неровной поверхности. Кроме того, проблема сильно варьирует в зависимости от вида воспроизводимого движения. Поэтому выделяют две категории баланса: статический для движений на месте и динамический.

В данной работе предлагается и анализируется способ поддержания статического баланса персонажа, следующего опорной анимации на основе локальной оптимизации и индикаторов баланса, описанных в \cite{MacchiettoZS}. В каждый момент времени решается задача квадратичного программирования, которая оптимизирует значения целевых функций, отвечающих за баланс и следование за анимацией. После персонаж приводится в движение в соответствии с результатами оптимизации. Более того, при изменение целевых функций описываемый способ может быть адаптирован для других проблем управления.

\subsection{Модель персонажа}

Перед тем как перейти к описанию разработанной системы, построим физическую модель персонажа и сформулируем уравнения, описывающие ее.

\subsubsection{Кинематическое дерево}

\begin{figure}
  \begin{minipage}[t]{0.475\textwidth}
    \centering
    \includegraphics[scale=0.25]{visual_model.png}
    \caption{Трехмерная модель}
    \label{fig:visual_model}
  \end{minipage}
\hfill
  \begin{minipage}[t]{0.475\textwidth}
    \centering
    \includegraphics[scale=0.25]{kinematic_tree.png}
    \caption{Кинематическое дерево. Круги обозначают шарниры, а соединения между кругами -- твердые тела}
    \label{fig:kinematic_tree}
  \end{minipage}
\end{figure}

Кинематическое дерево -- это система из $n$ твердых тел, соединенных между собой $m$ шарнирами. Каждый из шарниров, кроме корневого, ограничивает относительное движение тел, которые он соединяет. Например, призматический шарнир оставляет только поступательное движение вдоль выбранной оси. Корневой шарнир, в свою очередь, определяет возможность системы перемещаться в пространстве и бывает двух видов: плавающий, то есть не накладывающий ограничений, и фиксирующий.

Для того чтобы приводить в движение отдельные тела, некоторые шарниры могут быть снабжены приводами, которые генерируют необходимые силы и моменты сил. В таком случае шарнир называется активным, иначе, соответственно, неактивным. Отметим, что корневой шарнир обычно остается без привода. Таким образом за движение системы как целого отвечает сила трения, что сохраняет физическую корректность, но сильно усложняет управление кинематическим деревом.

В данной работе персонаж моделируется как кинематическое дерево, все шарниры которого имеют привод, причем силы и моменты сил, генерируемые в корневом шарнире, минимизируются в оптимизаторе. Такая модель в большинстве ситуаций эквивалентна кинематическому дереву с неактивным корневым шарниром, однако оставляет возможность нарушить физическую корректность при необходимости. На рисунках \ref{fig:visual_model} и \ref{fig:kinematic_tree} изображен пример трехмерной модели персонажа и соответствующего кинематического дерева.

\subsubsection{Обобщенные координаты}

При работе с кинематическим дерево важную роль играет способ, выбранный для описания положения и ориентации тел в пространстве, поскольку он во многом определят простоту, устойчивость и вычислительную сложность моделирования. Основные способы -- это максимальные координаты и обобщенные координаты.

Максимальные координаты описывают тела по отдельности, используя по 6 чисел на каждое, а ограничения, накладываемые шарнирами, учитывают при решении уравнения динамики. Такой способ позволяет использовать существующие системы физического моделирования, но страдает от ошибок работы с вещественными числами, которые приводят к тому, что тела открепляются друг от друга.

Обобщенные координаты, напротив, учитывают связи между телами. Например, для кинематического дерева, состоящего из двух тел, соединенных вращательным шарниром, используется 7 чисел, первые 6 из которых описывают положение и ориентацию одного из тел, а оставшееся -- угол поворота вокруг оси шарнира. Такой способ минимизирует количество используемых чисел и неявно учитывает ограничения.

В данной работе используются обобщенные координаты, скорости и ускорения. Отметим, что обобщенные скорости позволяют выразить скорость любого шарнира. Для этого необходимо умножить их на якобиан шарнира. После чего можно получить скорость любой точки твердого тела, прикрепленного к шарниру, зная ее положение.

\subsubsection{Уравнение динамики}

Уравнение динамики кинематического дерева, может быть выведено из принципа наименьшего действия, и имеет вид
\begin{equation}
  H(q) \ddot{q} + C(q, \dot{q}) + G(q) = u + J(q)^{T} f,
\end{equation}
где $q, \dot{q}, \ddot{q}$ -- обобщенные координаты, скорости и ускорения, $H$ -- матрица инерции, $C$ -- центробежная и кориолисова силы, $G$ -- сила тяготения, $u$ -- силы и моменты сил, генерируемые приводами, $J$ -- якобиан, и $f$ -- внешние силы.

В качестве неизвестной в этом уравнении может выступать $\ddot{q}$ или $u$. Алгоритмы, которые находят $\ddot{q}$, называются алгоритмами прямой динамики. В данной работе используется алгоритм articulated rigid body, описанный в \cite{Featherstone}, который имеет меньшую вычислительную сложностью в сравнении с численными методами решения уравнений.

\subsubsection{Импульс и момент импульса}

В разработке систем управления персонажем активно используются такие величины как импульс и момент импульса кинематического дерева, поскольку они тесно связаны с положениями центра масс и центра давления, которые, в свою очередь, являются индикаторами баланса.

Напомним, что центр давления -- это точка, где можно приложить результирующую сил нормальной реакции опоры и сил трения, так чтобы момент результирующей относительно центра масс, был таким же.

% TODO: Тут бы дорисовать руки, но не хочется
\begin{figure}[h]
  \begin{minipage}{\textwidth}
    \centering
    \begin{tikzpicture}
      % character
      \node [rectangle, minimum width = 0.7cm, minimum height = 3.0cm, draw, fill = white, rotate around = {19:(1.4, -2.1)}] at (1.4, -2.1) {};
      \node [rectangle, minimum width = 0.7cm, minimum height = 2.6cm, draw, fill = white] at (-0.4, -2.7) {};
      \node [rectangle, minimum width = 0.7cm, minimum height = 2.4cm, draw, fill = white, fill opacity = 1.0] at (-0.4, -5.2) {};
      \node [rectangle, minimum width = 0.7cm, minimum height = 2.4cm, draw, fill = white, fill opacity = 1.0] at (1.26, -5.2) {};
      \node [rectangle, minimum width = 1.5cm, minimum height = 3.0cm, draw, fill = white, fill opacity = 1.0] at (0, 0) {};

      % ground
      \draw (-2, -6.4) -- (2.8, -6.4);

      % gravity
      \filldraw [fill = black] (0.1, -0.5) circle (2pt) node [above left] {$c$};
      \draw [-{Latex[length=4mm, width=2mm]}, line width = 0.5mm] (0.1, -0.5)  -- node[left] {$mg$} (0.1, -3.0);

      % ground reaction force
      \filldraw [fill = black] (0.2, -6.4) circle (2pt) node [below right] {$p$};
      \draw [-{Latex[length=4mm, width=2mm]}, line width = 0.5mm] (0.2, -6.4) -- node[right] {$f$} (0.8, -4.4);

    \end{tikzpicture}
    \caption{Силы, действующие на персонажа}
    \label{fig:forces}
  \end{minipage}
\end{figure}

Рассмотрим персонажа и силы действующие на него, рисунок \ref{fig:forces}. Запишем второй закон Ньютона и основное уравнение вращательной динамики
\begin{align}
\dot{P} &= mg + f, \\
\dot{L} &= (p - c) \times f,
\end{align}
где $P$ -- импульс, $L$ -- момент импульса, $c$ -- центр масс, $p$ -- центр давления, $m$ -- суммарная масса, и $f$ -- результирующая сил нормальной реакции опоры и сил трения.

Выражая $f$ в уравнении 2 и подставляя в уравнение 3, имеем
\begin{align}
f &= \dot{P} - mg \\
\dot{L} &= (p - c) \times (\dot{P} - mg)
\end{align}

Запишем импульса для системы $n$ твердых тел
\begin{equation}
P = \sum_{i = 1}^{n} m_{i} \dot{x_{i}},
\end{equation}
где $x_{i}$, $m_{i}$ -- положения и массы. Используя следующую цепочку равенств
\begin{equation}
\sum_{i = 1}^{n} m_{i} \dot{x_{i}} = \frac{d}{dt} (\sum m_{i} x_{i}) = \frac{d}{dt} (mc) = m \dot{c},
\end{equation}
преобразуем уравнение 5 к виду
\begin{equation}
P = m \dot{c}.
\end{equation}
и, дифференцируя, к виду
\begin{equation}
  \dot{P} = m \ddot{c}.
\end{equation}

% Remove this
\subsubsection{Центроидальная матрица}

% Why do we need that information?
% This is the way to found angular and linear momentum

В \cite{OrinG} показана связь импульса и момента импульса, выраженных в неподвижной системе отсчета, расположенной в центре масс кинематического дерева, с обобщенными скоростями, имеющая следующий вид
\begin{equation}
\begin{bmatrix} P\\ L \end{bmatrix} = A(q) \dot{q},
\end{equation}
где $P$ -- импульс, $L$ -- момент импульса, а $A$ -- это центроидальная матрица.

Центроидальная матрица, как и матрицей инерции, является фундаментальной характеристикой кинематического дерева, которая зависит только от массы, инерции и значения обобщенных координат твердых тел, составляющих его.

% Таким образом можно вычислить импульс и момент импульса имея только, зная которые можно.
% связали положения центра массы и давления кинематического с его внутренними свойствами и обобщенными координатам, скоростями и ускорениями.

% Нам кстати friction тоже понадобится, же ниже :)
% Для условия трения, надо бы ее тоже отдельным уравнением

% В данной работе уравнения 4, 5, 6, 7 используются для н

% Тут видимо еще будет и будет дописываться что-то
